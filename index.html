<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales Comparison Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .loader {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg) }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
    <div id="root"></div>
    <div id="alert-container" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center gap-2"></div>

    <script type="module">
        // --- CONSTANTS ---
        const ACCESS_PASSWORD = "3737";
        const STORE_CONFIG = {
            '栄': { id: '1hj6JlN_c2UcHBXXKIVYXL7IUNNiwuxYJ', sheet: '栄' },
            '今池': { id: '1EDAZMKJ8kVlWLeUJbC3Dox5oNM8DTK3T', sheet: '今池' },
            '福岡': { id: '1su129OCN0Qw0lvZoNamByW1F1gYX5UmK', sheet: '福岡' },
        };
        const STORE_NAMES = Object.keys(STORE_CONFIG);
        const COMPARISON_KEYS = ['売上日計', 'サウナ', '宿泊売上計', 'マッサージ', 'グリル', '物販'];
        const SUMMABLE_KEYS = [
            '売上日計', 'サウナ', '宿泊売上計', 'マッサージ', 'グリル', '物販',
            '人数(S)', '人数(C)', '人数(M)', '件数(G)'
        ];
        const SUB_ITEM_MAP = {
            'サウナ': [['人数', '人数(S)']],
            '宿泊売上計': [['人数', '人数(C)']],
            'マッサージ': [['人数', '人数(M)']],
            'グリル': [['件数', '件数(G)']],
        };

        // --- STATE MANAGEMENT ---
        const state = {
            isAuthenticated: false,
            loading: false,
            error: null,
            allData: {},
            availableDates: [],
            selectedDate: localStorage.getItem('dashboard_selectedDate') ? JSON.parse(localStorage.getItem('dashboard_selectedDate')) : null,
            sortOrder: localStorage.getItem('dashboard_sortOrder') ? JSON.parse(localStorage.getItem('dashboard_sortOrder')) : 'newest',
            periodSummary: null,
            comparisonPeriodSummary: null,
            periodStartDate: localStorage.getItem('dashboard_periodStartDate') ? JSON.parse(localStorage.getItem('dashboard_periodStartDate')) : '2025-10-01',
            periodEndDate: localStorage.getItem('dashboard_periodEndDate') ? JSON.parse(localStorage.getItem('dashboard_periodEndDate')) : '2025-10-15',
            isSummarizing: false,
        };

        const rootEl = document.getElementById('root');
        const alertContainerEl = document.getElementById('alert-container');

        // --- UTILITY & SERVICE FUNCTIONS ---
        function sanitizeKey(str) {
            if (!str) return '';
            return str
                .replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/（/g, '(')
                .replace(/）/g, ')');
        }

        async function fetchSheetData(spreadsheetId, sheetName) {
            const query = 'select *';
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=${encodeURIComponent(query)}`;
           
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} for sheet: ${sheetName}`);
            }
           
            const text = await response.text();
            const jsonString = text.substring(47, text.length - 2);
            const data = JSON.parse(jsonString);

            if (data.status === 'error') {
                const errorMessage = data.errors.map((e) => e.detailed_message).join(', ');
                if (errorMessage.includes('ACCESS_DENIED')) {
                     throw new Error(`'${sheetName}'へのアクセスが拒否されました。シートが「リンクを知っている全員が閲覧可」または「ウェブに公開」に設定されているか確認してください。`);
                }
                throw new Error(errorMessage);
            }

            const rows = data.table.rows;
            const cols = data.table.cols;

            return rows.map((row) => {
                const rowData = {};
                row.c.forEach((cell, index) => {
                    const originalColLabel = cols[index].label;
                    const colLabel = sanitizeKey(originalColLabel);
                    let value = cell ? cell.v : null;

                    if (colLabel === '対象日' && typeof value === 'string' && value.startsWith('Date(')) {
                        const match = value.match(/Date\((\d+),(\d+),(\d+)\)/);
                        if (match) {
                            const [_, year, month, day] = match;
                            value = `${year}/${String(parseInt(month, 10) + 1).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
                        }
                    }
                   
                    const isNumericColumn = SUMMABLE_KEYS.includes(colLabel);
                    rowData[colLabel] = isNumericColumn ? (typeof value === 'number' ? value : 0) : value;
                });
                return rowData;
            }).filter((item) => item['対象日']);
        }

        async function fetchAllSheetsData() {
            const allData = {};
            const promises = STORE_NAMES.map(storeName => {
                const config = STORE_CONFIG[storeName];
                return fetchSheetData(config.id, config.sheet);
            });
            
            const results = await Promise.allSettled(promises);
            
            results.forEach((result, index) => {
                const storeName = STORE_NAMES[index];
                if (result.status === 'fulfilled') {
                    allData[storeName] = result.value;
                } else {
                    console.error(`Failed to fetch data for ${storeName}:`, result.reason);
                    allData[storeName] = []; 
                    throw result.reason;
                }
            });

            return allData;
        }

        function getComparisonDate(targetDate) {
            if (!targetDate) return null;
            const parts = targetDate.split(/[/-]/).map(p => parseInt(p, 10));
            if (parts.length !== 3) return null;
           
            const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            if (isNaN(dateObj.getTime())) return null;
           
            dateObj.setFullYear(dateObj.getFullYear() - 1);
            return `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
        }

        function calculateComparison(current, previous) {
            if (previous === undefined || previous === null) return { percentage: 'N/A', type: 'same' };
            if (previous === 0) {
                if (current > 0) return { percentage: '+∞%', type: 'increase' };
                if (current < 0) return { percentage: '-∞%', type: 'decrease' };
                return { percentage: '0%', type: 'same' };
            }
           
            const percentage = ((current - previous) / previous) * 100;
            let type = 'same';
            if (percentage > 0.05) type = 'increase';
            else if (percentage < -0.05) type = 'decrease';
           
            return { percentage: `${percentage > 0 ? '+' : ''}${percentage.toFixed(1)}%`, type };
        }

        const convertToCsv = (headers, data) => {
            const csvRows = [headers.join(',')];
            data.forEach(row => {
                const values = row.map(value => `"${String(value).replace(/"/g, '""')}"`);
                csvRows.push(values.join(','));
            });
            return csvRows.join('\n');
        };

        const downloadCsv = (csvString, filename) => {
            const blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const generateCsvRows = (dataGetter) => {
            const dataRows = [];
            STORE_NAMES.forEach(storeName => {
                COMPARISON_KEYS.forEach(mainKey => {
                    const { current, previous } = dataGetter(storeName, mainKey);
                    const comparison = calculateComparison(current, previous);
                    const difference = (previous !== undefined && previous !== null) ? current - previous : 'N/A';
                    dataRows.push([storeName, mainKey, current, previous ?? 'N/A', comparison.percentage, difference]);

                    (SUB_ITEM_MAP[mainKey] || []).forEach(([label, subKey]) => {
                        const { current: subCurrent, previous: subPrevious } = dataGetter(storeName, subKey);
                        const subComparison = calculateComparison(subCurrent, subPrevious);
                        const subDifference = (subPrevious !== undefined && subPrevious !== null) ? subCurrent - subPrevious : 'N/A';
                        dataRows.push([storeName, `  - ${label}`, subCurrent, subPrevious ?? 'N/A', subComparison.percentage, subDifference]);
                    });
                });
            });
            return dataRows;
        };

        const handleSingleDayCsvDownload = () => {
            const { storeData, comparisonData } = getMemoizedData();
            if(!state.selectedDate) return;
            const headers = ['店舗', 'カテゴリ', `売上 (${state.selectedDate})`, `前年売上 (${getComparisonDate(state.selectedDate) || 'N/A'})`, '前年比', '差額'];
            const dataGetter = (store, key) => ({
                current: (storeData[store]?.[key]) || 0,
                previous: (comparisonData[store]?.[key])
            });
            const csvRows = generateCsvRows(dataGetter);
            const csvString = convertToCsv(headers, csvRows);
            downloadCsv(csvString, `sales_daily_${state.selectedDate.replace(/\//g, '-')}.csv`);
        };

        const handlePeriodSummaryCsvDownload = () => {
            const start = state.periodStartDate.replace(/-/g, '/');
            const end = state.periodEndDate.replace(/-/g, '/');
            const headers = ['店舗', 'カテゴリ', `期間合計 (${start} - ${end})`, '前年同期間合計', '前年比', '差額'];
            const dataGetter = (store, key) => ({
                current: state.periodSummary[store]?.[key] || 0,
                previous: state.comparisonPeriodSummary?.[store]?.[key]
            });
            const csvRows = generateCsvRows(dataGetter);
            const csvString = convertToCsv(headers, csvRows);
            downloadCsv(csvString, `sales_period_${state.periodStartDate}_to_${state.periodEndDate}.csv`);
        };

        // --- RENDER FUNCTIONS ---
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return Number(num).toLocaleString('ja-JP', { maximumFractionDigits: 0 });
        }
       
        function renderLoader(message) {
            return `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4"></div>
                        <p class="text-xl text-slate-700">${message}</p>
                    </div>
                </div>`;
        }
       
        function showAlert(message, type = 'info', duration = 3000) {
            const alertId = `alert-${Date.now()}`;
            const colorMap = {
                info: 'bg-blue-100 text-blue-800 border-blue-400',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-400',
                error: 'bg-red-100 text-red-700 border-red-400'
            };
            const iconName = { info: 'info', warning: 'alert-triangle', error: 'alert-circle' };

            const alertEl = document.createElement('div');
            alertEl.id = alertId;
            alertEl.className = `p-4 rounded-lg shadow-xl border transition-all duration-300 opacity-0 transform translate-y-4 ${colorMap[type]}`;
            alertEl.innerHTML = `<i data-lucide="${iconName[type]}" class="w-5 h-5 inline-block align-text-bottom mr-2"></i> ${message}`;
           
            alertContainerEl.appendChild(alertEl);
            lucide.createIcons();

            setTimeout(() => {
                alertEl.classList.remove('opacity-0', 'translate-y-4');
            }, 10);

            setTimeout(() => {
                alertEl.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => alertEl.remove(), 300);
            }, duration);
        }

        function renderComparisonBadge({ current, previous, isLarge = false, unit = '¥' }) {
            if (previous === null || previous === undefined) {
                return `<span class="text-sm text-slate-500 w-full text-right sm:ml-4 whitespace-nowrap ${isLarge ? 'text-base' : ''}">比較データなし</span>`;
            }
            const comparison = calculateComparison(current, previous);
            const color = { increase: 'text-green-600', decrease: 'text-red-600', same: 'text-slate-500' }[comparison.type];
            const icon = { increase: 'trending-up', decrease: 'trending-down', same: 'minus' }[comparison.type];

            const prefix = unit === '¥' ? '¥' : '';
            const suffix = (unit === '人' || unit === '件') ? unit : '';
            const formattedPrevious = `${prefix}${formatNumber(previous)}${suffix}`;

            return `
                <div class="flex items-center justify-end w-full sm:ml-4">
                    <span class="text-slate-500 mr-2 whitespace-nowrap ${isLarge ? 'text-base' : 'text-xs'}">
                        前年: ${formattedPrevious}
                    </span>
                    <i data-lucide="${icon}" class="w-4 h-4 ${color} mr-1 flex-shrink-0 ${isLarge ? 'w-5 h-5' : ''}"></i>
                    <span class="font-semibold ${color} flex-shrink-0 whitespace-nowrap ${isLarge ? 'text-xl' : 'text-sm'}">
                        ${comparison.percentage}
                    </span>
                </div>`;
        }
       
        function renderSalesCard({ title, data, prevData, dataKey, subKeys = [] }) {
            const current = data?.[dataKey] || 0;
            return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow border border-slate-200">
                    <div class="p-4 border-b bg-slate-50 rounded-t-lg flex flex-wrap justify-between items-center gap-2">
                        <h3 class="text-lg font-semibold text-slate-700 truncate">${title}</h3>
                        ${renderComparisonBadge({ current: current, previous: prevData?.[dataKey], unit: "¥" })}
                    </div>
                    <div class="p-6">
                        <p class="text-3xl font-bold text-blue-600 mb-2">¥${formatNumber(current)}</p>
                        ${subKeys.length > 0 ? `
                            <div class="space-y-2 pt-2 border-t mt-4">
                                ${subKeys.map(([label, subKey]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-slate-600">${label}:</span>
                                        <span class="text-xl font-semibold text-slate-800">
                                            ${formatNumber(data?.[subKey] || 0)}${label.includes('人数') ? '人' : '件'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>`;
        }

        function renderDailyReport() {
            const { storeData, comparisonData, comparisonDate } = getMemoizedData();
            if (!state.selectedDate) {
                return '<div class="text-center p-8 bg-white rounded-lg shadow">日付を選択してください。</div>';
            }
            return `
                <div class="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm mb-6 border border-yellow-200 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4 flex-shrink-0"></i>
                    <span><strong>単日比較データ</strong>は、選択された日付の<strong>前年同日</strong>の売上を使用しています。</span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    ${STORE_NAMES.map(storeName => {
                        const data = storeData[storeName];
                        const prevData = comparisonData[storeName];

                        if (!data) {
                            return `
                                <div class="space-y-6">
                                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-xl shadow-xl">
                                        <h2 class="text-3xl font-bold text-center">${storeName}</h2>
                                    </div>
                                    <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col justify-center items-center min-h-[200px] border border-slate-200">
                                        <p class="text-slate-500">対象日のデータがありません</p>
                                    </div>
                                </div>`;
                        }

                        return `
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-xl shadow-xl">
                                    <h2 class="text-3xl font-bold text-center">${storeName}</h2>
                                    <p class="text-sm text-center mt-1 opacity-90">
                                        比較対象日: ${comparisonDate || 'なし'}
                                    </p>
                                </div>
                                ${renderSalesCard({ title: "売上日計", data, prevData, dataKey: "売上日計" })}
                                ${Object.entries(SUB_ITEM_MAP).map(([key, subItems]) => 
                                   renderSalesCard({ title: key, data, prevData, dataKey: key, subKeys: subItems })
                                ).join('')}
                                ${renderSalesCard({ title: "物販", data, prevData, dataKey: "物販" })}
                            </div>`;
                    }).join('')}
                </div>`;
        }
       
        function renderPeriodSummaryContent() {
            if (state.isSummarizing) {
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 text-center">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mx-auto mb-3"></div>
                        <p class="text-lg text-slate-600">期間データを集計中...</p>
                    </div>`;
            }

            if (!state.periodSummary) {
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">集計結果</h3>
                        <p class="text-slate-500">期間を設定し、「集計実行」ボタンを押してください。</p>
                    </div>`;
            }

            const categoryMap = [
                { key: 'サウナ', label: 'サウナ', subItems: [{ key: '人数(S)', label: '人数', unit: '人' }] },
                { key: '宿泊売上計', label: '宿泊', subItems: [{ key: '人数(C)', label: '人数', unit: '人' }] },
                { key: 'マッサージ', label: 'マッサージ', subItems: [{ key: '人数(M)', label: '人数', unit: '人' }] },
                { key: 'グリル', label: 'グリル', subItems: [{ key: '件数(G)', label: '件数', unit: '件' }] },
                { key: '物販', label: '物販', subItems: [] },
            ];
            
            const start = state.periodStartDate.replace(/-/g, '/');
            const end = state.periodEndDate.replace(/-/g, '/');

            return `
                <div class="bg-indigo-50 text-indigo-800 p-4 rounded-lg text-base mb-6 border border-indigo-200">
                    <p><strong>対象期間:</strong> ${start} 〜 ${end}</p>
                    <p><strong>比較期間:</strong> ${getComparisonDate(start)} 〜 ${getComparisonDate(end)} (前年同期間)</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    ${STORE_NAMES.map(storeName => {
                        const currentData = state.periodSummary[storeName];
                        const prevData = state.comparisonPeriodSummary?.[storeName];
                        const currentTotal = currentData['売上日計'] || 0;
                        const prevTotal = prevData?.['売上日計'];

                        return `
                            <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-indigo-100 hover:shadow-xl transition-shadow">
                                <h3 class="text-2xl font-extrabold text-indigo-700 mb-4 pb-2 border-b">${storeName} - 期間合計</h3>
                                <div class="mb-4">
                                    <p class="text-lg font-medium text-slate-600">売上日計 (期間合計)</p>
                                    <p class="text-4xl font-black text-indigo-600">¥${formatNumber(currentTotal)}</p>
                                </div>
                                <div class="mb-6">
                                    <p class="text-base font-medium text-slate-600">前年同期間比</p>
                                    ${renderComparisonBadge({ current: currentTotal, previous: prevTotal, isLarge: true, unit: "¥" })}
                                </div>
                                <h4 class="text-xl font-semibold text-slate-700 mt-4 pt-4 border-t">カテゴリ別内訳</h4>
                                <ul class="divide-y divide-slate-100">
                                    ${categoryMap.map(({ key, label, subItems }) => `
                                        <li class="py-3 space-y-2">
                                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                                <div class="mb-2 sm:mb-0">
                                                    <span class="text-base text-slate-600 font-medium">${label}:</span>
                                                    <span class="block sm:inline sm:ml-2 text-lg font-bold text-slate-800">¥${formatNumber(currentData[key] || 0)}</span>
                                                </div>
                                                <div class="w-full sm:w-auto">
                                                    ${renderComparisonBadge({ current: currentData[key] || 0, previous: prevData?.[key], unit: "¥" })}
                                                </div>
                                            </div>
                                            ${subItems.map(sub => `
                                                <div class="flex justify-between items-center pl-4">
                                                    <span class="text-sm text-slate-500">${sub.label}:</span>
                                                    <div class="flex flex-col items-end">
                                                        <span class="text-base font-semibold text-slate-700">${formatNumber(currentData[sub.key] || 0)}${sub.unit}</span>
                                                        ${renderComparisonBadge({ current: currentData[sub.key] || 0, previous: prevData?.[sub.key], unit: sub.unit })}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>`;
                    }).join('')}
                </div>`;
        }

        function renderPeriodSummary() {
            return `
                <section class="mt-12 pt-6 border-t border-slate-300">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-8 h-8 text-indigo-600"></i> 期間集計
                    </h2>
                    <div class="flex flex-col lg:flex-row items-center gap-4 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <div class="flex items-center gap-2 w-full lg:w-auto">
                            <label for="start-date" class="text-slate-700 font-medium whitespace-nowrap">開始日:</label>
                            <input type="date" id="start-date" value="${state.periodStartDate}" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <span class="text-xl text-slate-500 hidden lg:block">〜</span>
                        <div class="flex items-center gap-2 w-full lg:w-auto">
                            <label for="end-date" class="text-slate-700 
